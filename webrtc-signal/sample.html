<!DOCTYPE html>
<html>
<head>
  <title>Socket.IO Test</title>
</head>
<body>
  <h1>Hello</h1>
  <div class="messageBox">
    <input type="text">
  </div>

  <div class="sendbutton">
    <button>send</button>
  </div>

  <div class="incommingMessages">
    
  </div>
  
 
  <script src="/socket.io/socket.io.js"></script>

  <script type="module">


 const socket = io("https://localhost:9000");
//  , {key : readFileSync('./cert/cert.key'),
// cert : readFileSync('./cert/cert.crt')});

// const roomid = crypto.randomUUID();
const roomid = window.location.pathname.substring(1) || "test-room";


socket.on('connect', ()=>{
    console.log('connected to server:',socket.id);
    socket.emit('join-room',{ roomid });
});

const configuration = {'iceServers' : [{'urls':'stun:stun.l.google.com:19302'}]};
const peerConnection = new RTCPeerConnection(configuration);
let dataChannel;

peerConnection.addEventListener('datachannel', (event) =>{
    const datachannel = event.channel;
    setupDataChannel(datachannel);
});



const messageBox = document.querySelector('.messageBox input')
const sendButton = document.querySelector('.sendbutton button');
const incommingMessage = document.querySelector('#incomingMessages');

function setupDataChannel(dataChannel){
dataChannel.addEventListener('open', (event)=>{
    messageBox.disabled = false;
    messageBox.focus();
    sendButton.disabled = false;
});

dataChannel.addEventListener('close', (event)=>{
    messageBox.disabled = true;
    sendButton.disabled = true;
});

dataChannel.addEventListener('message', (event)=>{
    const message = event.data;
    incommingMessage.textContent += message + '\n'; 
});
}

sendButton.addEventListener('click', (event)=>{
    const message = messageBox.value;
    dataChannel.send({message});
});






//connectiom state
peerConnection.addEventListener('connectionstatechange', event =>{
    console.log('connection state',peerConnection.connectionState);
});

//initiator
socket.on('initiator', async ()=>{
    console.log('initiating by second peer');
    dataChannel = peerConnection.createDataChannel("chat");
    setupDataChannel(dataChannel);
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    socket.emit('offer',{ offer, roomid});
});

//offer
socket.on('offer', async (data)=>{
    const roomid = data.roomid;
    console.log("received offer");
    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    socket.emit('answer',{ answer, roomid});
});

//answer
socket.on('answer', async (data)=>{
    console.log('received answer');
    const remotedesc = new RTCSessionDescription(data.answer);
    await peerConnection.setRemoteDescription(remotedesc);
});

//new-ice-candidate
socket.on('new-ice-candidate', async (data)=>{
    console.log('received ICE');
    if(data.candidate){
        try{
            if(peerConnection.remoteDescription){
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        
            }
        }catch(e){
            console.error('error adding received ice candidate', e);
        }
    }
});

//ice candidates
peerConnection.addEventListener('icecandidate', (event)=>{
    if(event.candidate){
        console.log('sending ICE');
        socket.emit('new-ice-candidate',{ candidate: event.candidate, roomid});
    }
});

    </script>
 
</body>
</html>
