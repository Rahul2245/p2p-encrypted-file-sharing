<!DOCTYPE html>
<html>
<head>
  <title>Socket.IO Test</title>
</head>
<body>
  <h1>Hello</h1>
  <div class="messageBox">
    <input type="text">
  </div>

  <div class="sendbutton">
    <button>send</button>
  </div>

  <div class="incommingMessages">
    
  </div>

  <div id="shareSection" style="display:none;">
    <p>Share this link:</p>
    <input type="text" id="shareLink" readonly />

    <div id="qr"></div>
  </div>

  <div class="fileAttach"><input type="file" id="fileInput"></div>
  <div class="fileButton"><button id="sendFile">Send File</button></div>
  <div class="incommingFile"> </div>

  
 
  <script src="/socket.io/socket.io.js"></script>

   <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script type="module">


 const socket = io("https://192.168.41.227:9000");
//  , {key : readFileSync('./cert/cert.key'),
// cert : readFileSync('./cert/cert.crt')});

// const roomid = crypto.randomUUID();
// const roomid = window.location.pathname.substring(1) || "test-room";



//get roomid if exists
const params = new URLSearchParams(window.location.search);
const roomId = params.get("room");

let activeRoomId = null;
let isSender = false;
let selectedFile = null;



socket.on('connect', ()=>{
    console.log('connected to server:',socket.id);
    if(roomId){
   socket.emit('join-room',{ roomId });
   activeRoomId=roomId;
}
    
});

const configuration = {'iceServers' : [{'urls':'stun:stun.l.google.com:19302'}]};
const peerConnection = new RTCPeerConnection(configuration);
let dataChannel;

peerConnection.addEventListener('datachannel', (event) =>{
     dataChannel = event.channel;
    setupDataChannel(dataChannel);
});



const messageBox = document.querySelector('.messageBox input');
const sendButton = document.querySelector('.sendbutton button');
const incommingMessage = document.querySelector('.incommingMessages');
const fileButton = document.querySelector('#sendFile');
const attachFile = document.querySelector('#fileInput');
const incommingFile = document.querySelector('.incommingFile');
const shareSection = document.getElementById("shareSection");
const shareLink = document.getElementById("shareLink");
const qrDiv = document.getElementById("qr");


 function setupDataChannel(dataChannel){
dataChannel.binaryType = "arraybuffer";    
dataChannel.addEventListener('open', async (event)=>{
    messageBox.disabled = false;
    messageBox.focus();
    sendButton.disabled = false;
       if (isSender && selectedFile && peerConnection.connectionState === 'connected') {
            console.log('Sending file now...');
            dataChannel.send(selectedFile);
        }

});

dataChannel.addEventListener('close', (event)=>{
    messageBox.disabled = true;
    sendButton.disabled = true;
});


 dataChannel.addEventListener('message', (event) => {
        if (typeof event.data === 'string') {
            const p = document.createElement('p');
            p.textContent = event.data;
            incommingMessage.appendChild(p);
        } else {
            // Always default type for receiver
            console.log("got data");
           const blob = event.data instanceof Blob ? event.data : new Blob([event.data]);

            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
           a.download = event.data.name || "received_file";

            document.body.appendChild(a);
            // a.click();
            // a.remove();

            console.log('File received and downloaded automatically');
        }
    });


}

sendButton.addEventListener('click', ()=>{
    const message = messageBox.value;
    console.log(dataChannel);
    if (!dataChannel || dataChannel.readyState !== "open") {
        console.log("DataChannel not ready");
        return;
    }
    dataChannel.send(messageBox.value);
});

fileButton.addEventListener('click', (event)=>{
    
     if (!selectedFile) return alert("No file selected");
    dataChannel.send(selectedFile);
});


attachFile.addEventListener('change',(event)=>{
    isSender=true;
    if (!attachFile.files.length){ 
        alert('select a proper file');
        return;}
    selectedFile = attachFile.files[0];

        socket.emit('create-link');

});










//connectiom state
peerConnection.addEventListener('connectionstatechange', event =>{
    console.log('connection state',peerConnection.connectionState);
  
});

//backend response with roomid
socket.on('link-created', async ({ roomId })=>{
    const link = `${window.location.origin}/?room=${roomId}`;
     isSender=true;
activeRoomId = roomId;

    shareLink.value=link;
    shareSection.style.display="block";

    qrDiv.innerHTML = "";
    QRCode.toCanvas(link, { width :200}, (err, canvas)=>{
        if(!err) qrDiv.appendChild(canvas);
    });
   
    dataChannel = peerConnection.createDataChannel("chat");
    setupDataChannel(dataChannel);

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    socket.emit('offer', { offer, roomId });



})

//initiator
socket.on('initiator', async (data)=>{
    const roomId = data.roomId;
    console.log('initiating by second peer');
    
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    socket.emit('offer',{ offer, roomId});
});

//offer
socket.on('offer', async (data)=>{
    const roomId = data.roomId;
    console.log("received offer");
    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    socket.emit('answer',{ answer, roomId});
});

//answer
socket.on('answer', async (data)=>{
    console.log('received answer');
    const remotedesc = new RTCSessionDescription(data.answer);
    await peerConnection.setRemoteDescription(remotedesc);
});



//new-ice-candidate
socket.on('new-ice-candidate', async (data)=>{
    console.log('received ICE');
    if(data.candidate){
        try{
            if(peerConnection.remoteDescription){
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        
            }
        }catch(e){
            console.error('error adding received ice candidate', e);
        }
    }
});

//ice candidates
peerConnection.addEventListener('icecandidate', (event)=>{
    if(event.candidate){
        console.log('sending ICE');
        socket.emit('new-ice-candidate',{ candidate: event.candidate,  roomId: activeRoomId});
    }
});

    </script>
 
</body>
</html>
